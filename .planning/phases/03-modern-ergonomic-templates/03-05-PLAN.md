---
phase: 03-modern-ergonomic-templates
plan: 05
type: execute
wave: 4
depends_on:
  - "04"
files_modified:
  - Cargo.toml
  - src/cli.rs
  - src/main.rs
  - src/template/modern.rs
  - src/template/convert.rs
autonomous: true

must_haves:
  truths:
    - "Users can convert an existing .textfsm template into a best-effort modern YAML/TOML template via an interactive CLI"
    - "Converted templates load successfully through the modern template loader"
  artifacts:
    - path: src/template/convert.rs
      provides: "TextFSM IR -> modern document conversion"
    - path: src/cli.rs
      provides: "convert subcommand"
  key_links:
    - from: src/template/convert.rs
      to: src/template/modern.rs
      via: "serialize ModernTemplateDoc"
      pattern: "Modern"
---

<objective>
Provide an interactive conversion tool (TextFSM -> modern YAML/TOML) that is best-effort but produces strict-schema modern templates that load successfully.

Purpose: Satisfy Phase 03 migration requirement and make it practical to bootstrap modern templates from existing ecosystems.
Output: `cliscrape convert` subcommand + conversion logic + tests.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-modern-ergonomic-templates/03-CONTEXT.md
@.planning/phases/03-modern-ergonomic-templates/03-RESEARCH.md

@Cargo.toml
@src/cli.rs
@src/main.rs
@src/template/loader.rs
@src/template/modern.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement TextFSM IR -> modern document conversion</name>
  <files>
src/template/convert.rs
src/template/modern.rs
  </files>
  <action>
- Ensure the modern schema structs are reusable by the converter:
  - Make the modern document type (e.g., `ModernTemplateDoc`) and its nested structs public in `src/template/modern.rs`, OR
  - Provide a small public API in `src/template/modern.rs` for serialization (e.g., `to_yaml_string(&ModernTemplateDoc)`, `to_toml_string(&ModernTemplateDoc)`), which `convert.rs` uses.
- Create `src/template/convert.rs` with a pure function that maps `TemplateIR` (from `TextFsmLoader`) into the modern template document type from `src/template/modern.rs` (do not duplicate schema structs).
- Preserve as much as possible:
  - Values -> fields (pattern from Value.regex; required/filldown/list preserved).
  - States/rules/actions -> modern states/rules/actions.
- Keep types defaulted to string (or optionally set explicit types only when trivially safe).
- Ensure produced documents adhere to strict schema (no unknown keys; version set correctly).
  </action>
  <verify>cargo test</verify>
  <done>A converted modern document round-trips: serialize -> load via modern loader -> compile Template -> parse sample.</done>
</task>

<task type="auto">
  <name>Task 2: Add interactive `convert` CLI subcommand</name>
  <files>
Cargo.toml
src/cli.rs
src/main.rs
  </files>
  <action>
- Add dependency: `dialoguer` (per research) for interactive prompts.
- Add a new `convert` subcommand that:
  - reads a `.textfsm` template file,
  - interactively asks for output format (YAML/TOML) and output path,
  - writes the converted template.
- Non-interactive behavior (REQUIRED):
  - If `--output/-o` is provided, do NOT prompt for output path.
  - If `--format` is provided, do NOT prompt for format.
  - Only prompt for missing values.
- Use `serde_yaml_ng` / `toml` serialization helpers for output (prefer pretty formatting where available).
- Ensure the command errors clearly on unsupported input extensions.
  </action>
  <verify>
  - `cargo test`
  - Manual smoke: `cargo run -- convert -i path/to/template.textfsm` prompts for format + output path when flags are omitted.
  </verify>
  <done>
  - Non-interactive path works: `cargo run -- convert -i path/to/template.textfsm -o out.yaml --format yaml` produces a file that `FsmParser::from_file(out.yaml)` can load.
  - Interactive path works: running without `--output/--format` prompts and completes successfully.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for conversion correctness</name>
  <files>src/template/convert.rs</files>
  <action>
- Add unit tests that:
  - parse a small inline TextFSM template into `TemplateIR`,
  - convert to modern doc, serialize to YAML/TOML string,
  - load back via modern loader, compile, and parse a sample input to confirm equivalent record output.
- Keep tests in-memory (no interactive prompts in tests).
  </action>
  <verify>cargo test</verify>
  <done>Tests prove conversion output is loadable and functionally equivalent for simple templates.</done>
</task>

</tasks>

<verification>
- `cargo test`
- Manual smoke: run the converter on an existing `.textfsm` template and then parse a sample output using the produced modern file.
</verification>

<success_criteria>
- `cliscrape convert` exists, is interactive, and outputs strict-schema modern templates.
- Converted templates load successfully and parse at least simple cases equivalently.
</success_criteria>

<output>
After completion, create `.planning/phases/03-modern-ergonomic-templates/03-05-SUMMARY.md`
</output>
