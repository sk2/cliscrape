---
phase: 03-modern-ergonomic-templates
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/transcript/mod.rs
  - src/transcript/ios_prompt.rs
  - src/main.rs
autonomous: true

must_haves:
  truths:
    - "CLI parsing works on raw Cisco IOS-style transcripts that include prompts and command echoes (Phase 03 scope)"
    - "Prompt stripping is conservative: when confidence is low, input is left unchanged"
    - "Multi-command transcripts are segmented into per-command blocks before parsing"
  artifacts:
    - path: src/transcript/ios_prompt.rs
      provides: "Prompt/echo detection + segmentation"
    - path: src/transcript/mod.rs
      provides: "Public transcript preprocessing API"
    - path: src/main.rs
      provides: "CLI path uses transcript preprocessing"
  key_links:
    - from: src/main.rs
      to: src/transcript/mod.rs
      via: "preprocess input before parsing"
      pattern: "transcript"
---

<objective>
Add conservative Cisco IOS prompt + command-echo handling for raw CLI transcripts (Phase 03 scope), and segment multi-command transcripts into per-command blocks before parsing.

Purpose: Satisfy CLI-02 (prompt detection/handling) without corrupting normal command outputs.
Output: Transcript preprocessing module + CLI wiring.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-modern-ergonomic-templates/03-CONTEXT.md
@.planning/phases/03-modern-ergonomic-templates/03-RESEARCH.md

@src/main.rs
@src/cli.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement IOS prompt/echo detection and segmentation</name>
  <files>
src/transcript/mod.rs
src/transcript/ios_prompt.rs
  </files>
  <action>
- Create a new `src/transcript/` module with a focused API (e.g., `preprocess_ios_transcript(raw: &str) -> Vec<String>`).
- Implement a conservative IOS prompt regex (start-of-line, hostname-ish + optional mode parens, then `#` or `>`).
 - Confidence rules (must be conservative):
   - Default: treat input as a transcript if prompt-like lines are observed at least twice with a stable hostname base.
   - Also allow a high-confidence single-line case: a single prompt+command echo line at start-of-line (e.g., `Router# show ...`) is treated as transcript for echo-stripping purposes even if no trailing prompt exists.
   - If neither condition is met, return the original input as a single block.
- Segmentation behavior:
  - Strip prompt-only lines.
  - Strip prompt+command lines (command echo), but use them to start a new block.
  - Emit one block per command (block body excludes prompts/echo).
- Keep scope limited to prompts + command echoes only (explicitly do NOT handle paging markers, banners, syslog noise).
  </action>
  <verify>cargo test</verify>
  <done>A transcript containing `Router# show ...` and later `Router#` segments into a cleaned command output block without the prompt/echo lines.</done>
</task>

<task type="auto">
  <name>Task 2: Wire transcript preprocessing into CLI parse flow</name>
  <files>src/main.rs</files>
  <action>
- In the `parse` command path, preprocess `input_content` through the transcript module.
- Parse each produced block using the same loaded template; append all records in order into one result list.
- Ensure behavior is unchanged for normal non-transcript inputs (single block identical to original content).
  </action>
  <verify>cargo test</verify>
  <done>`cliscrape parse` can accept raw transcripts with prompts/echoes without breaking existing file/stdin parsing.</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for conservative behavior and segmentation</name>
  <files>
src/transcript/ios_prompt.rs
src/transcript/mod.rs
  </files>
  <action>
 - Add unit tests covering:
   - Positive: multi-command transcript segments into multiple blocks with prompts/echo removed.
   - Positive (single prompt+command): a one-line echo like `Router# show version` is stripped and the remaining block contains only the command output lines.
   - Negative: a single prompt-like line (or ambiguous lines) does NOT trigger stripping/segmentation.
   - Config-mode prompts like `Router(config)#` are still recognized as prompt lines tied to the same hostname base.
  </action>
  <verify>cargo test</verify>
  <done>Tests demonstrate both segmentation and non-destructive fallback when confidence is low.</done>
</task>

</tasks>

<verification>
- `cargo test`
- (Optional manual) Run: `cargo run -- parse -t templates/modern/ios_show_interfaces.yaml transcript.txt` and confirm prompts/echoes are ignored when present.
</verification>

<success_criteria>
- Prompt/echo lines are stripped only under high confidence.
- Multi-command transcripts are parsed as separate blocks with results concatenated.
</success_criteria>

<output>
After completion, create `.planning/phases/03-modern-ergonomic-templates/03-02-SUMMARY.md`
</output>
