---
phase: 03-modern-ergonomic-templates
plan: 03
type: execute
wave: 2
depends_on:
  - "01"
files_modified:
  - Cargo.toml
  - src/template/modern.rs
  - src/template/mod.rs
  - src/lib.rs
  - src/engine/types.rs
autonomous: true

must_haves:
  truths:
    - "User can define a template in YAML or TOML and load it by file extension"
    - "Modern schema validation is strict: unknown keys fail with a path-aware error"
    - "Modern templates support both explicit states and pattern-only mode"
    - "Modern templates can declare explicit field types (at least int) that drive JSON typed output"
    - "Template-local macros are lowered into TemplateIR for end-to-end macro expansion"
  artifacts:
    - path: src/template/modern.rs
      provides: "Strict YAML/TOML schema + lowering to TemplateIR"
    - path: src/lib.rs
      provides: "FsmParser loads modern templates by extension"
    - path: src/engine/types.rs
      provides: "Value supports optional type_hint used by conversion"
  key_links:
    - from: src/template/modern.rs
      to: src/engine/types.rs
      via: "lower fields/rules into TemplateIR"
      pattern: "TemplateIR"
    - from: src/lib.rs
      to: src/template/modern.rs
      via: "load modern template by extension"
      pattern: "modern"
---

<objective>
Implement the modern ergonomic template formats (YAML/TOML) with strict schema validation and lowering into `TemplateIR`, so the existing engine can run modern templates.

Purpose: Satisfy FORM-02 (modern template format) while preserving the existing FSM engine as the execution core.
Output: Modern template loader/compiler + extension-based loading in `FsmParser`.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-modern-ergonomic-templates/03-CONTEXT.md
@.planning/phases/03-modern-ergonomic-templates/03-RESEARCH.md

@Cargo.toml
@src/lib.rs
@src/template/loader.rs
@src/engine/fsm.rs
@src/engine/macros.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add strict modern YAML/TOML schema + loader</name>
  <files>
Cargo.toml
src/template/modern.rs
src/template/mod.rs
  </files>
  <action>
- Add dependencies (per research): `toml`, `serde_yaml_ng`, `serde_path_to_error`.
- Create `src/template/modern.rs` defining serde-deserializable structs for the modern template document.
- Enforce strict validation:
  - Use `#[serde(deny_unknown_fields)]` on every schema struct/enum.
  - Validate invariants after deserialization (e.g., exactly one of `states` or `patterns` is present; version supported).
- Schema must support (Phase 03 locked decisions):
  - YAML + TOML with the same logical structure.
  - Hybrid: explicit state machine mode and pattern-only mode.
  - Template-local macros that can shadow builtins.
  - Both capture styles: `${Field}` placeholders AND native named capture groups; field definitions determine what is emitted/typed.
 - Provide a `load_*` function that returns a lowered `TemplateIR` suitable for `Template::from_ir`.
  - Include explicit typing in the schema (this is REQUIRED for FORM-03; do not rely on heuristic conversion):
     - Add `fields.<name>.type` with a strict enum of allowed values.
     - Must include at least `int` (recommended also: `string` so templates can explicitly *disable* numeric heuristics).
      - Default when omitted: treat as `string`.
        - IMPORTANT: This means the lowered IR MUST set `Value.type_hint = Some(FieldType::String)` when `fields.<name>.type` is omitted.
        - Rationale: avoids heuristic-based type surprises in modern templates; templates opt into typing explicitly.
   - Lowering MUST wire schema typing into the engine-level type hint:
     - When lowering schema fields into `TemplateIR`, set each lowered `Value.type_hint` (from Phase 03-01) from `fields.<name>.type`.
     - Use the engine enum (e.g., `FieldType::Int` / `FieldType::String`) rather than a parallel ad-hoc type.
     - Ensure this survives both YAML and TOML loaders (same logical behavior).
    - Add unit/integration tests proving explicit typing drives output (not heuristics):
      - Test A (explicit int): modern doc declares `fields.speed.type = int`, input contains `speed=1,234`, output record has `speed` as a JSON number.
      - Test B (explicit string overrides heuristics): modern doc declares `fields.speed.type = string`, same input `speed=1,234`, output record has `speed` as a JSON string (this demonstrates declared typing beats heuristics).
      - In at least one test, assert the lowered IR contains `Value.type_hint == Some(FieldType::Int)` (or equivalent) for the field.
      - Add a negative test that an unknown type (e.g., `type = "integer"`) fails schema validation with a path-aware error.
    - Ensure template-local macro overrides are wired end-to-end:
      - Lower the modern document's `macros` map into `TemplateIR.macros` so `Template::from_ir` expansion uses locals over builtins.
      - Add a test where a modern template defines `macros.ipv4 = "X"` and a rule uses `{{ipv4}}`; prove the compiled regex contains `X` (and not the builtin ipv4 pattern).
  - If a rule references `${field}` but `fields[field].pattern` is missing, error during load (fail early).
  </action>
  <verify>cargo test</verify>
  <done>Modern templates deserialize with strict unknown-key errors, and `fields.*.type` is lowered into `TemplateIR` such that `Value.type_hint` drives typed JSON output (with tests proving `int` and `string` behavior).</done>
</task>

<task type="auto">
  <name>Task 2: Load modern templates by extension in FsmParser</name>
  <files>src/lib.rs</files>
  <action>
- Update `FsmParser::from_file` to support:
  - `.textfsm` (existing behavior)
  - `.yaml` / `.yml` (modern)
  - `.toml` (modern)
- Keep error messages actionable (include detected extension and supported set).
- Do not change the public parse output shape; only template loading logic changes.
  </action>
  <verify>cargo test</verify>
  <done>Calling `FsmParser::from_file` on a `.yaml`/`.toml` modern template succeeds and produces a working parser.</done>
</task>

</tasks>

<verification>
- `cargo test`
- Manually load a tiny inline modern template (via test) and confirm it parses a sample string into records.
</verification>

<success_criteria>
- YAML/TOML modern templates load strictly and compile to `TemplateIR`.
- Macro semantics match Phase 03 decisions (template-local overrides lowered into `TemplateIR.macros`).
</success_criteria>

<output>
After completion, create `.planning/phases/03-modern-ergonomic-templates/03-03-SUMMARY.md`
</output>
