---
phase: 03-modern-ergonomic-templates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/engine/types.rs
  - src/engine/records.rs
  - src/engine/mod.rs
  - src/engine/convert.rs
autonomous: true

must_haves:
  truths:
    - "When a field declares type=int, emitted JSON contains a JSON number (not a string)"
    - "When conversion fails, the original captured value is preserved as a string"
    - "Heuristic numeric conversion upgrades obviously-numeric strings to JSON numbers when no explicit type is set"
  artifacts:
    - path: src/engine/convert.rs
      provides: "String->typed serde_json::Value conversion"
    - path: src/engine/records.rs
      provides: "Record emission applies type conversion"
    - path: src/engine/types.rs
      provides: "Value metadata includes optional type hint"
  key_links:
    - from: src/engine/records.rs
      to: src/engine/convert.rs
      via: "convert at emit-time"
      pattern: "convert"
---

<objective>
Add a typed-conversion pipeline at record emission time so modern templates can emit useful JSON primitives (especially ints) without changing regex capture behavior.

Purpose: Satisfy FORM-03 (typed captures + automatic type conversion) while keeping the FSM/regex engine string-based.
Output: A conversion module + engine changes so records emit typed serde_json::Value.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-modern-ergonomic-templates/03-CONTEXT.md
@.planning/phases/03-modern-ergonomic-templates/03-RESEARCH.md

@src/engine/types.rs
@src/engine/records.rs
@src/engine/fsm.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add field type metadata + conversion utility</name>
  <files>
src/engine/types.rs
src/engine/mod.rs
src/engine/convert.rs
  </files>
  <action>
- Introduce a new enum for field typing (e.g., `FieldType`) that is extensible and safe to carry on `Value`.
- Extend `Value` to include `type_hint: Option<FieldType>` (default None for legacy TextFSM).
- Implement `src/engine/convert.rs` with a small, focused API (e.g., `convert_scalar(raw: &str, hint: Option<FieldType>) -> serde_json::Value`).
- Conversion rules (must match Phase 03 decisions):
  - Explicit type hint wins.
  - If explicit conversion fails: return the original raw string.
  - Heuristic fallback when hint is None: attempt lenient numeric parsing only (strip commas/underscores; allow leading +/-).
- Keep conversion policy isolated in `convert.rs`; do NOT convert during regex capture.
  </action>
  <verify>cargo test</verify>
  <done>`Value` can optionally carry a type hint and there is a reusable converter that returns `serde_json::Value`.</done>
</task>

<task type="auto">
  <name>Task 2: Apply typed conversion at record emission</name>
  <files>src/engine/records.rs</files>
  <action>
- Update `RecordBuffer::emit` so emitted records contain typed JSON values:
  - For non-list fields: convert the last captured scalar.
  - For list fields: convert each element.
- Preserve existing missing-value behavior ("" for scalars, [] for lists) unless a value is actually captured.
- Preserve existing Required/Filldown/List semantics.
- Ensure behavior remains backward-compatible for legacy templates (no type hints => heuristic numeric only).
  </action>
  <verify>cargo test</verify>
  <done>At least one unit test demonstrates int conversion (e.g., "1,234" -> 1234) and a failed conversion preserves the original string.</done>
</task>

<task type="auto">
  <name>Task 3: Add focused tests for typed and heuristic conversion</name>
  <files>src/engine/records.rs</files>
  <action>
- Add unit tests covering:
  - Explicit int conversion to `serde_json::Value::Number`.
  - List field conversion (array of numbers for typed numeric list).
  - Conversion failure fallback (keeps string).
  - Heuristic numeric conversion for an untyped field (numeric-ish string becomes a number).
  </action>
  <verify>cargo test</verify>
  <done>Tests prove conversion behavior without changing the FSM regex capture path.</done>
</task>

</tasks>

<verification>
- `cargo test`
- Confirm at least one emitted record contains a JSON number (not a string) for a typed int field.
</verification>

<success_criteria>
- Engine can emit typed JSON values at record emission time.
- Conversion is explicit-first, numeric-heuristic fallback only, and never drops records on conversion failure.
</success_criteria>

<output>
After completion, create `.planning/phases/03-modern-ergonomic-templates/03-01-SUMMARY.md`
</output>
