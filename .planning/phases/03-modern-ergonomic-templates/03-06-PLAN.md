---
phase: 03-modern-ergonomic-templates
plan: 06
type: execute
wave: 3
depends_on:
  - "03"
files_modified:
  - src/template/modern.rs
  - src/engine/macros.rs
autonomous: true

must_haves:
  truths:
    - "Modern schema invariants are enforced and verified by tests (states xor patterns, version gating)"
    - "Modern templates support both capture styles: ${Field} placeholders and native named capture groups"
    - "Template-local macros override builtins end-to-end (schema -> IR -> compilation)"
    - "Macro expansion supports recursion with cycle detection"
  artifacts:
    - path: src/template/modern.rs
      provides: "Modern template tests proving wiring/invariants"
    - path: src/engine/macros.rs
      provides: "Recursive deterministic macro expansion + cycle errors"
  key_links:
    - from: src/template/modern.rs
      to: src/engine/macros.rs
      via: "TemplateIR.macros -> Template::from_ir expand_macros"
      pattern: "macros"
---

<objective>
De-risk the modern template layer by adding targeted schema wiring/invariant tests and upgrading macro expansion to be recursive, deterministic, and cycle-safe.

Purpose: Reduce execution risk in the main modern-loader plan and lock in the most failure-prone behavior with tests.
Output: Macro recursion/cycle detection + focused modern schema tests.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/03-modern-ergonomic-templates/03-CONTEXT.md
@.planning/phases/03-modern-ergonomic-templates/03-RESEARCH.md

@src/template/modern.rs
@src/engine/macros.rs
@src/engine/fsm.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add targeted tests for modern schema invariants + wiring</name>
  <files>src/template/modern.rs</files>
  <action>
  - Add focused tests covering the highest-risk wiring points:
    - Invariant enforcement: exactly one of `states` or `patterns` present (and unsupported `version` fails).
    - Capture style support:
      - Placeholder `${Field}` works (requires field pattern defined).
      - Named capture groups work without a placeholder.
    - Macro precedence: template-local `macros` override builtins and affect compiled regex (assert compiled regex contains local override).
    - Path-aware errors: at least one negative test asserts error messages include a useful field path (via `serde_path_to_error`).
  - Keep tests minimal; do not rely on CLI execution.
  </action>
  <verify>cargo test</verify>
  <done>
  Tests explicitly prove schema invariants, capture-style support, macro override precedence, and strict path-aware failures.
  </done>
</task>

<task type="auto">
  <name>Task 2: Upgrade macro expansion to recursive with cycle detection</name>
  <files>src/engine/macros.rs</files>
  <action>
  - Update macro expansion semantics to support macro-in-macro recursively with:
    - a small max depth (e.g., 10) and
    - explicit cycle detection that errors on cycles.
  - Preserve precedence: template-local macros override builtins.
  - Keep expansion deterministic (do not depend on HashMap iteration order).
  - Ensure existing macro tests still pass; add at least one new test for nested macros and one for cycle detection.
  </action>
  <verify>cargo test</verify>
  <done>Macros can expand recursively and cycles are rejected with a clear error message.</done>
</task>

</tasks>

<verification>
- `cargo test`
</verification>

<success_criteria>
- Macro expansion is recursive, deterministic, and cycle-safe.
- Modern schema invariants + wiring are protected by tests.
</success_criteria>

<output>
After completion, create `.planning/phases/03-modern-ergonomic-templates/03-06-SUMMARY.md`
</output>
