---
phase: 03-modern-ergonomic-templates
plan: 04
type: execute
wave: 3
depends_on:
  - "03-02"
  - "03-03"
files_modified:
  - src/cli.rs
  - src/main.rs
  - src/lib.rs
  - templates/modern/ios_show_interfaces.yaml
  - templates/modern/simple_hostname.toml
  - tests/modern_templates.rs
autonomous: true

must_haves:
  truths:
    - "Users can run `cliscrape parse` with a modern YAML/TOML template file"
    - "CLI can override template format selection when extension is ambiguous"
    - "Numeric captures from modern templates are emitted as integers in JSON output"
  artifacts:
    - path: templates/modern/ios_show_interfaces.yaml
      provides: "Starter modern YAML template"
    - path: templates/modern/simple_hostname.toml
      provides: "Starter modern TOML template"
    - path: tests/modern_templates.rs
      provides: "End-to-end tests covering modern template loading + typed output"
  key_links:
    - from: src/cli.rs
      to: src/main.rs
      via: "template format override flag"
      pattern: "template"
---

<objective>
Polish the CLI UX for modern templates (including optional explicit format override) and ship a small starter pack of modern templates with end-to-end tests.

Purpose: Make Phase 03 immediately usable from the CLI and prove the full path: modern template -> parse -> typed JSON.
Output: CLI flag(s), starter templates in-repo, and integration tests.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-modern-ergonomic-templates/03-CONTEXT.md
@.planning/phases/03-modern-ergonomic-templates/03-RESEARCH.md

@src/cli.rs
@src/main.rs
@src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add optional CLI template format override</name>
  <files>
src/cli.rs
src/main.rs
src/lib.rs
  </files>
  <action>
- Add a `--template-format` flag to `cliscrape parse` (e.g., `auto|textfsm|yaml|toml`) to override extension inference.
- Implement a corresponding code path that forces the loader selection (do not rely on extension when override is set).
- Ensure `auto` remains the default and preserves current behavior.
- Keep override behavior well-scoped to template loading; do not change parsing semantics.
  </action>
  <verify>cargo test</verify>
  <done>`cliscrape parse --template-format yaml -t template.unknown` can load YAML explicitly (covered by a test).</done>
</task>

<task type="auto">
  <name>Task 2: Add a small starter pack of modern templates</name>
  <files>
templates/modern/ios_show_interfaces.yaml
templates/modern/simple_hostname.toml
  </files>
  <action>
- Add at least two curated templates demonstrating:
  - YAML state-machine mode with a typed int capture.
  - TOML pattern-only mode.
- Keep regex strings quoted (YAML 1.1 implicit typing pitfall).
- Keep templates small and easy to run in tests.
  </action>
  <verify>cargo test</verify>
  <done>Templates exist in-repo and are usable by the library/CLI.</done>
</task>

<task type="auto">
  <name>Task 3: Add end-to-end tests for modern templates + typed output</name>
  <files>tests/modern_templates.rs</files>
  <action>
- Add integration tests that:
  - Load the starter YAML/TOML templates via `FsmParser::from_file` (and via override where appropriate).
  - Parse a small sample input and assert:
    - at least one record is produced, and
    - the numeric capture is a JSON number (int).
- Keep tests deterministic and independent of the CLI binary output formatting.
  </action>
  <verify>cargo test</verify>
  <done>Tests prove modern template loading + typed conversion works end-to-end.</done>
</task>

</tasks>

<verification>
- `cargo test`
- (Optional manual) `cargo run -- parse -t templates/modern/ios_show_interfaces.yaml sample.txt`
</verification>

<success_criteria>
- CLI supports modern templates and an explicit override to force format selection.
- In-repo starter templates exist and are covered by tests.
</success_criteria>

<output>
After completion, create `.planning/phases/03-modern-ergonomic-templates/03-04-SUMMARY.md`
</output>
