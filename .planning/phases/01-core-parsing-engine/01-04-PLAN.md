---
phase: 01-core-parsing-engine
plan: 04
type: execute
wave: 4
depends_on: ["01-03"]
files_modified: ["src/engine/fsm.rs"]
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "Unit tests prove deterministic Start -> STATE2 transitions via regex matches"
    - "Unit tests prove next_state == 'End' terminates parsing early"
  artifacts:
    - path: "src/engine/fsm.rs"
      provides: "FSM parse loop + state transitions + End termination tests"
  key_links:
    - from: "src/engine/fsm.rs"
      to: "Template::parse"
      via: "tests asserting multi-state transitions"
      pattern: "test_.*state_.*transition"
    - from: "src/engine/fsm.rs"
      to: "Rule.next_state == 'End'"
      via: "early return in parse loop"
      pattern: "next == \"End\""
---

<objective>
Close the Phase 1 verification gap by adding missing unit tests that demonstrate deterministic state transitions (Start -> STATE2) and correct End-state termination behavior.

Purpose: Make FSM behavior provably deterministic and termination-safe.
Output: New unit tests in `src/engine/fsm.rs` covering Start -> STATE2 and End termination.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-parsing-engine/01-VERIFICATION.md
@src/engine/fsm.rs
@src/engine/types.rs
@src/engine/records.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add unit test for Start -> STATE2 transition</name>
  <files>src/engine/fsm.rs</files>
  <action>
    In `src/engine/fsm.rs` within the existing `#[cfg(test)] mod tests`, add a new test (name it clearly, e.g. `test_state_transition_start_to_state2`).

    Test requirements:
    - Build a `TemplateIR` with two states: `Start` and `STATE2`.
    - `Start` contains a rule that matches the first line and sets `next_state: Some("STATE2".to_string())`.
    - `STATE2` contains a rule that matches the second line and uses `record_action: Action::Record` to emit a record.
    - Capture values using `${ValueName}` placeholders so captures flow through `Template::from_ir` value expansion.
    - Parse a two-line input and assert:
      1) exactly one record is returned
      2) the record contains the expected captured values from both lines

    Keep the test minimal and deterministic (no random inputs, no reliance on rule ordering beyond the explicit rule list).
  </action>
  <verify>
    Run `cargo test engine::fsm::tests::test_state_transition_start_to_state2`.
  </verify>
  <done>
    A unit test demonstrates that a match in `Start` moves to `STATE2` and parsing continues in the new state, producing the expected record.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit test for End-state termination</name>
  <files>src/engine/fsm.rs</files>
  <action>
    In `src/engine/fsm.rs` within the existing test module, add a new test (name it clearly, e.g. `test_end_state_terminates_parse`).

    Test requirements:
    - Build a `TemplateIR` with `Start` state containing a rule that matches a line, emits a record, and sets `next_state: Some("End".to_string())`.
    - Provide input with additional lines that would otherwise match and emit more records if parsing continued.
    - Assert that parsing returns early:
      1) results contain only the record from the terminating match
      2) no subsequent lines are processed into records
  </action>
  <verify>
    Run `cargo test engine::fsm::tests::test_end_state_terminates_parse`.
  </verify>
  <done>
    A unit test proves `next_state == "End"` causes `Template::parse` to return immediately after handling the matching rule.
  </done>
</task>

</tasks>

<verification>
- `cargo test engine::fsm` passes.
- The new tests cover both Start -> STATE2 transitions and End termination.
</verification>

<success_criteria>
- VERIFICATION gap #1 is closed: deterministic state transitions and End termination are proven by unit tests.
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-parsing-engine/01-04-SUMMARY.md`
</output>
