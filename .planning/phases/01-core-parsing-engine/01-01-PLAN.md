---
phase: 01-core-parsing-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: ["src/lib.rs", "src/engine/mod.rs", "src/engine/types.rs", "src/engine/macros.rs"]
autonomous: true
must_haves:
  truths:
    - "Core engine types are defined and exported from the engine module"
    - "Built-in regex macros (e.g., ipv4, mac_address) are correctly expanded in patterns"
    - "Local template definitions correctly shadow built-in macros"
  artifacts:
    - path: "src/engine/mod.rs"
      provides: "Module exports"
    - path: "src/engine/types.rs"
      provides: "FSM data structures (State, Rule, Action, Value)"
    - path: "src/engine/macros.rs"
      provides: "Regex macro expansion logic"
  key_links:
    - from: "src/lib.rs"
      to: "src/engine/mod.rs"
      via: "pub mod engine"
---

<objective>
Establish the project structure for the FSM engine and implement the built-in regex macro library. This foundation will support the core parsing logic in subsequent steps.
</objective>

<execution_context>
@/Users/simonknight/.gemini/get-shit-done/workflows/execute-plan.md
@/Users/simonknight/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/1-CONTEXT.md
@src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Engine Module Structure</name>
  <files>src/lib.rs, src/engine/mod.rs, src/engine/types.rs</files>
  <action>
    Create the directory `src/engine`.
    1. Create `src/engine/mod.rs` to export submodules `types` and `macros`.
    2. Create `src/engine/types.rs` to define the following structs and enums:
       - `Value`: `name: String`, `regex: String`, `filldown: bool`, `required: bool`.
       - `Action`: Enum with `Next`, `Continue`, `Record`, `Clear`.
       - `Rule`: `regex: String`, `line_action: Action`, `record_action: Action`, `next_state: Option<String>`.
       - `State`: `name: String`, `rules: Vec<Rule>`.
    3. Update `src/lib.rs` to expose the `engine` module and remove redundant type definitions (moving them to types.rs).
  </action>
  <verify>
    Run `cargo check` to ensure the project still compiles and modules are correctly linked.
  </verify>
  <done>
    Module structure is created and core types are defined in `src/engine/types.rs`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Regex Macro Library</name>
  <files>src/engine/macros.rs</files>
  <action>
    Implement the built-in regex macro library in `src/engine/macros.rs`.
    1. Implement `get_builtin_macros() -> HashMap<String, String>` returning:
       - `ipv4`: `\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}`
       - `mac_address`: `[0-9a-fA-F]{2}(:[0-9a-fA-F]{2}){5}`
       - `interface`: `\S+`
       - `word`: `\w+`
       - `eol`: `$`
    2. Implement `expand_macros(regex: &str, local_overrides: &HashMap<String, String>) -> String`.
       - Replace `{{name}}` with values from `local_overrides` (priority) or built-in macros.
       - Use simple string replacement without recursion.
    3. Add a unit test `test_macro_shadowing` to verify that `local_overrides` take precedence over built-ins.
  </action>
  <verify>
    Run `cargo test engine::macros` to verify expansion logic and shadowing.
  </verify>
  <done>
    Macro expansion logic is implemented and verified with unit tests.
  </done>
</task>

</tasks>

<verification>
- `cargo check` passes.
- `src/engine/types.rs` contains all required structs.
- Unit tests for macro shadowing pass.
</verification>

<success_criteria>
Core FSM types are established and the regex macro system can resolve patterns with template-local overrides.
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-parsing-engine/01-01-SUMMARY.md`
</output>
