---
phase: 02-legacy-compatibility-cli
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified: [Cargo.toml, src/engine/types.rs, src/engine/records.rs, src/output.rs, src/cli.rs, src/main.rs]
autonomous: true

must_haves:
  truths:
    - "--format csv produces valid CSV output to stdout"
    - "--format table produces a pretty-printed table"
    - "Value List attributes correctly accumulate multiple matches into a single record"
  artifacts:
    - path: "src/output.rs"
      provides: "Record serialization logic"
  key_links:
    - from: "src/main.rs"
      to: "src/output.rs"
      via: "Formatter::format"
---

<objective>
Enhance the CLI with multiple output formats (CSV, Table) and finalize legacy compatibility by supporting the `List` attribute for values. This makes the tool versatile for both automation and human inspection.

Purpose: Professional output and full legacy feature support.
Output: CSV/Table support and Value List accumulation.
</objective>

<execution_context>
@/Users/simonknight/.gemini/get-shit-done/workflows/execute-plan.md
@/Users/simonknight/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/engine/records.rs
@src/engine/types.rs
@.planning/phases/02-legacy-compatibility-cli/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Value List Support</name>
  <files>src/engine/types.rs, src/engine/records.rs</files>
  <action>
    1. Add `list: bool` to `Value` struct in `src/engine/types.rs`.
    2. Update `RecordBuffer` to store values as `Vec<String>` instead of `String`.
    3. Modify `RecordBuffer::insert`:
       - If `list` is true for the value, append to the vector.
       - If `list` is false, overwrite the vector (size 1).
    4. Update `emit` and `reset_after_emit` to handle the new `Vec` structure.
    5. Ensure `emit` returns a `HashMap<String, serde_json::Value>` (or similar) to represent lists in JSON.
  </action>
  <verify>Add a test case in `records.rs` where a value is marked as `list` and multiple matches are inserted. Verify the emitted record contains all values for that key.</verify>
  <done>The engine correctly accumulates multiple values for keys marked with the `List` attribute.</done>
</task>

<task type="auto">
  <name>Task 2: Serialization Module (CSV & Table)</name>
  <files>Cargo.toml, src/output.rs</files>
  <action>
    1. Add `serde = { version = "1.0", features = ["derive"] }`, `serde_json = "1.0"`, `csv = "1.3"`, and `tabled = "0.15"` to Cargo.toml.
    2. Create `src/output.rs` with a `Formatter` enum or trait.
    3. Implement `to_json`, `to_csv`, and `to_table` for `Vec<HashMap<String, String>>`.
    4. For `List` values in CSV/Table, decide on a join character (e.g. newline or space) or handle appropriately.
  </action>
  <verify>Run unit tests in `output.rs` that verify the string output for each format matches expected structure.</verify>
  <done>Multiple output formats are implemented and ready for CLI integration.</done>
</task>

<task type="auto">
  <name>Task 3: CLI Integration and Final Polish</name>
  <files>src/cli.rs, src/main.rs</files>
  <action>
    1. Update `src/cli.rs` to support `csv` and `table` in the `--format` enum.
    2. Update `src/main.rs` to use the new `Formatter` based on the user's choice.
    3. Clean up any debug prints.
  </action>
  <verify>Execute `cliscrape parse --template example.fsm data.txt --format table` and verify a table is printed to stdout.</verify>
  <done>User can choose between JSON, CSV, and Table outputs from the CLI.</done>
</task>

</tasks>

<verification>
1. `cliscrape parse -f csv` output is valid CSV.
2. `cliscrape parse -f table` output is readable and correctly aligned.
3. Templates using `Value List` work correctly.
</verification>

<success_criteria>
- Comprehensive output options for different use cases.
- Full support for TextFSM's Value attributes (Filldown, Required, List).
</success_criteria>

<output>
After completion, create `.planning/phases/02-legacy-compatibility-cli/02-03-SUMMARY.md`
</output>
