---
phase: 04-tui-debugger-foundation-(live-lab)
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - Cargo.toml
  - src/tui/mod.rs
  - src/tui/app.rs
  - src/tui/watch.rs
  - src/tui/worker.rs
  - src/tui/event.rs
  - src/tui/ui.rs
autonomous: true

must_haves:
  truths:
    - "Changing the template or input file triggers an automatic re-parse while the TUI runs"
    - "On parse error, the TUI keeps last-good results visible and shows the new error"
    - "Parsing work does not freeze the UI"
  artifacts:
    - path: "src/tui/watch.rs"
      provides: "Debounced file watch -> Message stream"
    - path: "src/tui/worker.rs"
      provides: "Background parse worker -> ParseDone/ParseError"
  key_links:
    - from: "src/tui/watch.rs"
      to: "src/tui/app.rs"
      via: "Message::FsChanged triggers ParseRequest"
      pattern: "FsChanged"

---

<objective>
Add live reload: debounced file watching + background parsing, with last-good retention and an error panel.

Purpose: Live Lab must feel instant while remaining stable during rapid template edits.
Output: notify-based watcher, parse worker thread, and UI state that surfaces errors without blanking.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/04-tui-debugger-foundation-(live-lab)/04-RESEARCH.md

@Cargo.toml
@src/tui/app.rs
@src/tui/ui.rs
</context>

<tasks>

<task type="auto">
  <name>Add notify dependencies for debounced filesystem watching</name>
  <files>Cargo.toml</files>
  <action>
- Add dependencies:
  - `notify`
  - `notify-debouncer-mini`
- Keep versions compatible with Rust 2024 edition and existing dependency graph.
  </action>
  <verify>cargo build</verify>
  <done>`cargo build` succeeds with the new dependencies added.</done>
</task>

<task type="auto">
  <name>Implement debounced file watch producing FsChanged messages</name>
  <files>
src/tui/watch.rs
src/tui/mod.rs
  </files>
  <action>
- Implement `watch::start_watcher(template_path, input_path, sender)`:
  - Use `notify-debouncer-mini` with ~150ms debounce.
  - Watch parent directory of each file (to handle replace-on-save atomic renames); filter events to only the target filenames.
  - Emit `Message::FsChanged { which: Template|Input }` (or similar) into the main loop channel.
- Ensure watcher is shut down cleanly when app exits.
  </action>
  <verify>cargo build</verify>
  <done>Saving template/input in an editor produces a single debounced FsChanged message most of the time (no storm spam).</done>
</task>

<task type="auto">
  <name>Move parsing into a worker thread and add error panel + last-good retention</name>
  <files>
src/tui/worker.rs
src/tui/app.rs
src/tui/event.rs
src/tui/ui.rs
src/tui/mod.rs
  </files>
  <action>
- Implement a parse worker thread that accepts `ParseRequest { template_path, input_path, block_idx }` over a channel and responds with:
  - `Message::ParseDone(DebugReport)` on success
  - `Message::ParseError(String)` (renderable) on failure
- Worker does ALL heavy work: read files, preprocess ios transcript, load template, run `debug_parse`.
- In `AppState`, keep:
  - `last_good: Option<DebugReport>`
  - `current_error: Option<String>`
  - `status: Parsing|Ok|Error` (+ last reload timestamp optional)
- UI behavior on ParseError: keep rendering `last_good` but show error panel with the new error.
  </action>
  <verify>cargo build</verify>
  <done>TUI stays responsive during reload; parse errors do not blank results and are visible in an error panel.</done>
</task>

</tasks>

<verification>
- `cargo build`
- Manual sanity: run debug TUI, edit template to introduce syntax error, observe last-good remains + error panel shows message; fix template, observe results update.
</verification>

<success_criteria>
- Reload loop is debounced and non-blocking.
- Error panel clearly indicates current parse failure while keeping last good visible.
</success_criteria>

<output>
After completion, create `.planning/phases/04-tui-debugger-foundation-(live-lab)/04-03-SUMMARY.md`
</output>
