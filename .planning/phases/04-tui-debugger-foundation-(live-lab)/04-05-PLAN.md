---
phase: 04-tui-debugger-foundation-(live-lab)
plan: 05
type: execute
wave: 5
depends_on: ["04-04"]
files_modified:
  - src/tui/mod.rs
  - src/tui/app.rs
  - src/tui/ui.rs
  - src/tui/event.rs
  - src/tui/editor.rs
  - src/tui/picker.rs
autonomous: false

must_haves:
  truths:
    - "User can launch `cliscrape debug` with missing paths and select template/input inside the TUI"
    - "User can edit the template inline and see matches update on save"
    - "When edits break parsing, last-good remains and error panel updates"
  artifacts:
    - path: "src/tui/editor.rs"
      provides: "Minimal inline template editor buffer"
    - path: "src/tui/picker.rs"
      provides: "In-TUI file/path picker for template and input"
  key_links:
    - from: "src/tui/editor.rs"
      to: "src/tui/worker.rs"
      via: "save triggers ParseRequest / watcher reload"
      pattern: "Save"

---

<objective>
Add the in-TUI workflow features: path picker when flags are missing and a minimal inline template editor.

Purpose: Phase 4 explicitly includes in-app selection and inline editing to keep iteration loop tight.
Output: Picker UI, editor mode, and a verified end-to-end Live Lab loop.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/04-tui-debugger-foundation-(live-lab)/04-CONTEXT.md
@.planning/phases/04-tui-debugger-foundation-(live-lab)/04-RESEARCH.md

@src/tui/app.rs
@src/tui/ui.rs
</context>

<tasks>

<task type="auto">
  <name>Implement minimal inline template editor mode</name>
  <files>
src/tui/editor.rs
src/tui/app.rs
src/tui/event.rs
src/tui/ui.rs
src/tui/mod.rs
  </files>
  <action>
- Implement an in-app editor buffer over `Vec<String>` with:
  - Insert char, backspace, delete, newline, left/right/up/down
  - A scroll offset so the editor can handle longer files
  - Save to the current template path (write file atomically: write temp + rename if easy; otherwise overwrite)
- Add `Mode::{Browse, EditTemplate}` in app state.
- Keybindings (recommendation): `e` to enter edit, `Esc` to exit edit, `Ctrl+S` to save.
- Editor UI: reuse one pane (e.g., details pane) to show the editor with a clear status header.
- After save, trigger a parse refresh (either by explicitly enqueueing a ParseRequest or relying on watcher; prefer explicit refresh for immediacy).
  </action>
  <verify>cargo build</verify>
  <done>Template can be edited inline and saved; save triggers a refresh attempt without freezing the UI.</done>
</task>

<task type="auto">
  <name>Add in-TUI picker for missing template/input paths</name>
  <files>
src/tui/picker.rs
src/tui/app.rs
src/tui/event.rs
src/tui/ui.rs
src/tui/mod.rs
  </files>
  <action>
- Implement a simple picker state that can:
  - List candidate files from a starting directory (default: current working directory)
  - Navigate list (up/down) and select
  - Allow manual path entry as an alternative (single-line input)
- Integrate startup flow:
  - If template or input path missing, start in Picker mode.
  - Once both are set, trigger initial parse and switch to Browse mode.
- Keep picker implementation minimal and robust; no need for recursive tree browsing in Phase 4.
  </action>
  <verify>cargo build</verify>
  <done>`cliscrape debug` without flags offers an in-TUI picker to select both template and input, then loads into the main 3-pane view.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Picker + inline editor integrated into Live Lab TUI (with live reload + error retention)</what-built>
  <how-to-verify>
1. Run: `cargo run -- debug`.
2. Use the in-TUI picker to choose:
   - template: `templates/modern/ios_show_interfaces.yaml`
   - input: `examples/output.txt`
3. In Browse mode:
   - Navigate lines with both arrows and `j/k`.
   - Confirm matched lines are shaded and capture spans are highlighted for the selected match.
   - Toggle Records view (Tab) and confirm records list + details update.
4. Enter editor mode (`e`), change a regex so it matches fewer/more lines, save (`Ctrl+S`):
   - Confirm highlights update within ~300ms.
5. Introduce an invalid regex/template syntax, save:
   - Confirm last-good highlights remain.
   - Confirm error panel shows the new error.
6. Fix the error, save:
   - Confirm error clears and results update.
7. Quit (`q`) and confirm terminal is restored (no raw-mode issues).
  </how-to-verify>
  <resume-signal>Type "approved" or describe what failed (include key presses and what you expected).</resume-signal>
</task>

</tasks>

<verification>
- `cargo build`
- Human verification checkpoint for interactive behavior.
</verification>

<success_criteria>
- `cliscrape debug` is usable without CLI flags (picker) and supports inline template edits.
- Live reload is stable: last-good retained on error, errors visible, no UI freezes.
</success_criteria>

<output>
After completion, create `.planning/phases/04-tui-debugger-foundation-(live-lab)/04-05-SUMMARY.md`
</output>
