---
phase: 04-tui-debugger-foundation-(live-lab)
plan: 04
type: execute
wave: 4
depends_on: ["04-03"]
files_modified:
  - src/tui/app.rs
  - src/tui/ui.rs
  - src/tui/event.rs
  - src/tui/mod.rs
autonomous: true

must_haves:
  truths:
    - "Matched lines are visually distinct and capture spans are highlighted"
    - "Details pane shows typed fields plus rule context (state/rule/action) for the selected match"
    - "User can toggle between per-line matches view and emitted-records view"
  artifacts:
    - path: "src/tui/ui.rs"
      provides: "Highlight rendering for raw pane and match/details panes"
    - path: "src/tui/event.rs"
      provides: "Keymap for view toggles and navigation"
  key_links:
    - from: "src/tui/ui.rs"
      to: "cliscrape::DebugReport"
      via: "build Line/Span from capture byte offsets"
      pattern: "Span::styled"

---

<objective>
Implement core Live Lab visualization: matched-line shading, capture-span highlights, rule context, and the matches-vs-records toggle.

Purpose: This is the minimum set of UI affordances needed to make template iteration productive.
Output: Rich 3-pane rendering plus keybindings for toggles and match navigation.
</objective>

<execution_context>
@~/.opencode/get-shit-done/workflows/execute-plan.md
@~/.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/04-tui-debugger-foundation-(live-lab)/04-CONTEXT.md

@src/tui/app.rs
@src/tui/ui.rs
@src/engine/debug.rs
</context>

<tasks>

<task type="auto">
  <name>Render raw-pane highlights: selected line, matched line shading, capture span accents</name>
  <files>src/tui/ui.rs</files>
  <action>
- In the raw text pane:
  - Always show the line cursor clearly (distinct background/marker column).
  - Shade matched lines (any line with 1+ `LineMatch`) with a subtle background.
  - For the currently selected match (selected line + selected stacked match index), render capture-span highlights using `start_byte..end_byte`.
- Implement a safe highlight builder that slices the `&str` using byte offsets only (avoid char-index conversions). Assume ASCII is common, but do not panic on UTF-8; if an offset is invalid, skip that span and surface a non-fatal debug warning in the error panel/status.
- Keep styling readable (avoid intense colors; prioritize contrast with selection).
  </action>
  <verify>cargo build</verify>
  <done>Matched lines and capture spans are visually distinct; highlight rendering never panics on unexpected offsets.</done>
</task>

<task type="auto">
  <name>Implement matches pane stacking + details pane with typed fields and rule context</name>
  <files>
src/tui/app.rs
src/tui/ui.rs
  </files>
  <action>
- App state:
  - Track `selected_line_idx` and `selected_match_idx` (index into that line's stacked matches).
- Matches pane:
  - Show a list of matches for the selected line (stacked entries), including: state_before, rule_idx, actions, next_state/state_after.
  - Allow cycling `selected_match_idx` with keys (e.g., `[` and `]` or `h/l`).
- Details pane:
  - Show capture fields for the selected match: `name = typed` (and optionally raw in parentheses).
  - Show rule context: state_before -> state_after, line_action, record_action.
  </action>
  <verify>cargo build</verify>
  <done>User can inspect multiple matches per line and see typed capture values plus rule context for the selected match.</done>
</task>

<task type="auto">
  <name>Add view toggle between per-line matches and emitted records</name>
  <files>
src/tui/event.rs
src/tui/app.rs
src/tui/ui.rs
  </files>
  <action>
- Add `ViewMode::{Matches, Records}` to app state and a keybinding to toggle (e.g., `Tab`).
- In Records mode:
  - Matches pane shows emitted records list (line_idx + short preview).
  - Details pane shows full record key/value set for selected record.
- Keep raw pane cursor behavior consistent; selecting a record should also move the raw cursor to the record's line_idx.
  </action>
  <verify>cargo build</verify>
  <done>Toggle switches between match-centric and record-centric views while keeping panes synced to selection.</done>
</task>

</tasks>

<verification>
- `cargo build`
- Manual sanity: run TUI, move to a matched line, verify shading; toggle Records view; verify details update.
</verification>

<success_criteria>
- Match visualization is readable and supports Continue stacking.
- Details pane provides both typed fields and rule context.
- Records toggle works and stays in lockstep with the raw pane cursor.
</success_criteria>

<output>
After completion, create `.planning/phases/04-tui-debugger-foundation-(live-lab)/04-04-SUMMARY.md`
</output>
