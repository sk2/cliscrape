---
phase: 07-compatibility-validation-suite
plan: 05
type: execute
wave: 3
depends_on: [07-01, 07-02, 07-03, 07-04]
files_modified:
  - .github/workflows/ci.yml
autonomous: true
requirements: [VAL-04]

must_haves:
  truths:
    - "Developer sees validation suite run on every push to main"
    - "Developer receives CI failure if snapshots need review"
    - "Developer can verify benchmarks compile without running them in CI"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "GitHub Actions workflow with validation"
      contains: "cargo insta test --check"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "tests/validation.rs"
      via: "cargo test --test validation"
      pattern: "cargo.*test.*validation"
    - from: ".github/workflows/ci.yml"
      to: "cargo-insta"
      via: "cargo install cargo-insta"
      pattern: "cargo install.*insta"
---

<objective>
Integrate validation suite into CI/CD pipeline to prevent snapshot regressions.

Purpose: Ensure validation tests run on every commit and fail if snapshots require manual review, preventing accidental acceptance of breaking changes.

Output: GitHub Actions workflow that installs cargo-insta, runs validation tests with --check flag, and compiles benchmarks.
</objective>

<execution_context>
@/Users/simonknight/.claude/get-shit-done/workflows/execute-plan.md
@/Users/simonknight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-compatibility-validation-suite/07-CONTEXT.md
@.planning/phases/07-compatibility-validation-suite/07-RESEARCH.md
@.planning/phases/07-compatibility-validation-suite/07-01-SUMMARY.md
@.planning/phases/07-compatibility-validation-suite/07-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create or update GitHub Actions CI workflow</name>
  <files>
    .github/workflows/ci.yml
  </files>
  <action>
Create or update .github/workflows/ci.yml to include validation suite following RESEARCH.md CI pattern and CONTEXT.md locked decision: "Manual review required for snapshot updates via cargo insta review".

If .github/workflows/ci.yml already exists, add validation job. If it doesn't exist, create complete workflow.

Use RESEARCH.md recommendation: "Always use cargo insta test --check in CI (fails if snapshots pending review)".

Add validation job to workflow:

```yaml
name: CI

on:
  push:
    branches: [main, master]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run regular tests
        run: cargo test --lib --bins

      - name: Install cargo-insta
        run: cargo install cargo-insta --locked

      - name: Run validation tests
        run: cargo insta test --test validation --check
        # --check fails if snapshots pending review (prevents auto-acceptance)

      - name: Compile benchmarks
        run: cargo bench --no-run
        # Ensures benchmarks compile without running them (saves CI time)
```

Key points per RESEARCH.md:
- Use dtolnay/rust-toolchain@stable (not deprecated actions-rs)
- Install cargo-insta in CI before running tests
- Use --check flag to fail on pending snapshots
- Compile benchmarks but don't run (cargo bench --no-run)
- Cache cargo registry and build artifacts

If existing CI workflow has different structure, preserve existing jobs and add validation as new job or additional steps.
  </action>
  <verify>
cat .github/workflows/ci.yml
  </verify>
  <done>
.github/workflows/ci.yml exists with validation job. Workflow includes cargo-insta installation, cargo insta test --check command, and benchmark compilation. Uses dtolnay/rust-toolchain and actions/cache@v4.
  </done>
</task>

</tasks>

<verification>
Verify workflow syntax:
```bash
cat .github/workflows/ci.yml | grep -A 5 "cargo insta"
```

Check workflow is valid YAML:
```bash
ruby -ryaml -e "YAML.load_file('.github/workflows/ci.yml')" 2>&1
```

Verify workflow includes required steps:
```bash
grep -E "(cargo insta test --check|cargo bench --no-run)" .github/workflows/ci.yml
```

If possible, trigger workflow manually or push to test branch to verify it runs.
</verification>

<success_criteria>
- .github/workflows/ci.yml exists
- Workflow includes cargo install cargo-insta step
- Workflow runs cargo insta test --test validation --check
- Workflow compiles benchmarks with cargo bench --no-run
- Workflow uses dtolnay/rust-toolchain@stable (not deprecated actions-rs)
- Workflow caches cargo dependencies
- Workflow triggers on push to main and pull requests
- YAML syntax is valid
</success_criteria>

<output>
After completion, create `.planning/phases/07-compatibility-validation-suite/07-05-SUMMARY.md`
</output>
